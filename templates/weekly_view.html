{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <h5 class="mb-0 me-3">Âë®ËßÜÂõæ</h5>
                <div>
                    <a href="{{ url_for('add_manual_record') }}" class="btn btn-primary btn-sm me-2">
                        Ë°•ÁôªÂ∑•Êó∂
                    </a>
                    <a href="{{ url_for('export_weekly', week=current_week_offset) }}" class="btn btn-success btn-sm">
                        ÂØºÂá∫Excel
                    </a>
                </div>
            </div>
            <div class="btn-group">
                <a href="{{ url_for('weekly_view', week=current_week_offset-1) }}" class="btn btn-outline-primary">&lt; ‰∏äÂë®</a>
                <a href="{{ url_for('weekly_view', week=0) }}" class="btn btn-outline-primary {{ 'active' if current_week_offset == 0 }}">Êú¨Âë®</a>
                <a href="{{ url_for('weekly_view', week=current_week_offset+1) }}" class="btn btn-outline-primary">‰∏ãÂë® &gt;</a>
            </div>
        </div>
        <div class="alert alert-info mb-0">
            <div class="d-flex justify-content-between align-items-center">
                <span>Êú¨Âë®ÊÄªÂ∑•Êó∂Ôºö<strong>{{ week_total }}h</strong></span>
                <span>Êó•ÂùáÂ∑•Êó∂(5Â§©)Ôºö<strong>{{ "%.1f"|format(week_total / 5) }}h</strong></span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr class="table-light">
                        <th class="text-center bg-light">Êó•Êúü</th>
                        <th class="text-center bg-light">Êó∂ÊÆµ</th>
                        <th class="text-center bg-light">Â∑•Êó∂</th>
                        <th class="text-center bg-light">Â∑•‰ΩúÂÜÖÂÆπ</th>
                        <th class="text-center bg-light">Ë°•ÂÖÖËØ¥Êòé</th>
                    </tr>
                </thead>
                <tbody>
                    {% for date in week_dates %}
                        {% set morning_records = records|selectattr('date', 'eq', date)|selectattr('time_period', 'eq', 'morning')|list %}
                        {% set afternoon_records = records|selectattr('date', 'eq', date)|selectattr('time_period', 'eq', 'afternoon')|list %}
                        {% set morning_rows = morning_records|length or 1 %}
                        {% set afternoon_rows = afternoon_records|length or 1 %}
                        {% set total_rows = morning_rows + afternoon_rows %}
                        
                        <!-- ‰∏äÂçàËÆ∞ÂΩïË°å -->
                        {% for record in morning_records %}
                            <tr class="{{ 'table-active' if date == today }}">
                                {% if loop.first %}
                                    <td class="align-middle text-center" rowspan="{{ total_rows }}">
                                        {{ date.strftime('%m/%d') }}
                                        <br>
                                        <small>{{ ['‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠','Êó•'][date.weekday()] }}</small>
                                    </td>
                                    <td class="align-middle text-center" rowspan="{{ morning_rows }}">‰∏äÂçà</td>
                                {% endif %}
                                <td>{{ record.hours }}h</td>
                                <td>{{ record.project_name }}</td>
                                <td>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ record.description or '' }}</span>
                                        <div class="btn-group btn-group-sm ms-2">
                                            <a href="{{ url_for('manage_record', record_id=record.id) }}" 
                                               class="btn btn-outline-primary btn-sm">
                                                ‚úèÔ∏è
                                            </a>
                                            <button type="button" class="btn btn-outline-danger btn-sm delete-record"
                                                    data-id="{{ record.id }}"
                                                    data-project="{{ record.project_name }}">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr class="{{ 'table-active' if date == today }}">
                                <td class="align-middle text-center" rowspan="{{ total_rows }}">
                                    {{ date.strftime('%m/%d') }}
                                    <br>
                                    <small>{{ ['‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠','Êó•'][date.weekday()] }}</small>
                                </td>
                                <td class="align-middle text-center">‰∏äÂçà</td>
                                <td colspan="3" class="text-center">
                                    <span class="text-muted">Êó†ËÆ∞ÂΩï</span>
                                </td>
                            </tr>
                        {% endfor %}
                        
                        <!-- ‰∏ãÂçàËÆ∞ÂΩïË°å -->
                        {% for record in afternoon_records %}
                            <tr class="{{ 'table-active' if date == today }}">
                                {% if loop.first %}
                                    <td class="align-middle text-center" rowspan="{{ afternoon_rows }}">‰∏ãÂçà</td>
                                {% endif %}
                                <td>{{ record.hours }}h</td>
                                <td>{{ record.project_name }}</td>
                                <td>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ record.description or '' }}</span>
                                        <div class="btn-group btn-group-sm ms-2">
                                            <a href="{{ url_for('manage_record', record_id=record.id) }}" 
                                               class="btn btn-outline-primary btn-sm">
                                                ‚úèÔ∏è
                                            </a>
                                            <button type="button" class="btn btn-outline-danger btn-sm delete-record"
                                                    data-id="{{ record.id }}"
                                                    data-project="{{ record.project_name }}">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr class="{{ 'table-active' if date == today }}">
                                <td class="align-middle text-center">‰∏ãÂçà</td>
                                <td colspan="3" class="text-center">
                                    <span class="text-muted">Êó†ËÆ∞ÂΩï</span>
                                </td>
                            </tr>
                        {% endfor %}
                        
                        <!-- ÂΩìÊó•ÁªüËÆ° -->
                        <tr class="{{ 'table-active' if date == today }}">
                            <td colspan="2" class="text-end"><strong>ÂΩìÊó•ÁªüËÆ°</strong></td>
                            <td colspan="3">
                                ‰∏äÂçàÔºö{{ daily_stats[date]['morning_hours'] }}h | 
                                ‰∏ãÂçàÔºö{{ daily_stats[date]['afternoon_hours'] }}h | 
                                ÊÄªËÆ°Ôºö<strong>{{ daily_stats[date]['total_hours'] }}h</strong>
                            </td>
                        </tr>
                        
                        {% if loop.index < week_dates|length %}
                            <tr><td colspan="5" class="p-0"><hr class="m-0"></td></tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.table > :not(caption) > * > * {
    padding: 0.5rem;
}
hr {
    border-top: 1px solid rgba(0,0,0,.1);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function deleteRecord(id) {
    const button = event.target.closest('button');
    const projectName = button.dataset.project;
    
    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§"' + projectName + '"ÁöÑÂ∑•Êó∂ËÆ∞ÂΩïÂêóÔºü')) {
        fetch('/record/' + id, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert('Âà†Èô§Â§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
        });
    }
}

// Âà†Èô§ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
document.querySelectorAll('.delete-record').forEach(button => {
    button.addEventListener('click', function() {
        const id = this.dataset.id;
        deleteRecord(id);
    });
});
</script>
{% endblock %}